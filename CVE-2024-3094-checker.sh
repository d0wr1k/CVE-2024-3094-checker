#!/bin/bash
# CVE-2024-3094-checker.sh
# Verificação rápida e simples para verificar se uma versão vulnerável de xz-utils está instalada
# https://nvd.nist.gov/vuln/detail/CVE-2024-3094
# Fork do projeto

# Este script shell é fornecido como está e sem garantia de qualquer tipo, expressa ou implícita.
# Ao executar este script, você reconhece que o faz por sua própria conta e risco.
# Os autores deste script não serão responsáveis por quaisquer danos ou problemas que possam surgir de seu uso, incluindo, mas não se limitando a perda de dados, instabilidade do sistema ou quaisquer outras consequências não intencionais.
# Recomenda-se revisar o script e entender sua funcionalidade antes de executá-lo e garantir que backups adequados estejam em vigor.
# O uso deste script implica na aceitação destes termos.
# Adicionado outros gerenciadores de pacote.

# Detectar o gerenciador de pacotes
if command -v apt &>/dev/null; then
    PKG_MANAGER="apt"
elif command -v apt-get &>/dev/null; then
    PKG_MANAGER="apt-get"
elif command -v yum &>/dev/null; then
    PKG_MANAGER="yum"
elif command -v dnf &>/dev/null; then
    PKG_MANAGER="dnf"
elif command -v pacman &>/dev/null; then
    PKG_MANAGER="pacman"
elif command -v zypper &>/dev/null; then
    PKG_MANAGER="zypper"
else
    echo "Gerenciador de pacotes não suportado. Saindo."
    exit 1
fi

# Verificar se a versão é vulnerável
case "$PKG_MANAGER" in
    apt|apt-get)
        version=$(dpkg -l xz-utils | awk '/xz-utils/{print $3}')
        ;;
    yum|dnf)
        version=$(rpm -q xz)
        ;;
    pacman)
        version=$(pacman -Qi xz | awk '/Versão/{print $3}')
        ;;
    zypper)
        version=$(rpm -q xz)
        ;;
    *)
        echo "Gerenciador de pacotes não suportado. Saindo."
        exit 1
        ;;
esac

if [[ $version =~ (5\.6\.(0|1)) && ! $version =~ revertto ]]; then
    echo "Parece que você tem uma versão vulnerável do pacote xz instalada em seu sistema"
    echo "Executando $PKG_MANAGER para atualizar o pacote xz..."

    case "$PKG_MANAGER" in
        apt|apt-get)
            sudo $PKG_MANAGER install --only-upgrade xz-utils
            ;;
        yum)
            sudo $PKG_MANAGER update xz
            ;;
        dnf)
            sudo $PKG_MANAGER upgrade xz
            ;;
        pacman)
            sudo $PKG_MANAGER -Syu xz
            ;;
        zypper)
            sudo $PKG_MANAGER refresh
            sudo $PKG_MANAGER update xz
            ;;
    esac

    if [ $? -eq 0 ]; then
        echo "Pacote xz atualizado com sucesso. Agora é aconselhável reiniciar."
    else
        echo "Falha na atualização do pacote xz."
    fi
else
    echo "Seu pacote xz está atualizado e não é vulnerável."
fi
